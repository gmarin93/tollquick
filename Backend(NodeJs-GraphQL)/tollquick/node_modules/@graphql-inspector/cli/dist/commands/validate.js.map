{"version":3,"file":"validate.js","sourceRoot":"","sources":["../../src/commands/validate.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  validate as validateDocuments,\n  InvalidDocument,\n} from '@graphql-inspector/core';\nimport {loadSchema, loadDocuments} from '@graphql-inspector/load';\n\nimport {\n  Renderer,\n  ConsoleRenderer,\n  renderInvalidDocument,\n  renderDeprecatedUsageInDocument,\n} from '../render';\n\nexport async function validate(\n  documentsPointer: string,\n  schemaPointer: string,\n  options: {\n    require?: string[];\n    deprecated: boolean;\n    noStrictFragments: boolean;\n    maxDepth?: number;\n    renderer?: Renderer;\n    headers?: Record<string, string>;\n  },\n) {\n  const renderer = options.renderer || new ConsoleRenderer();\n\n  try {\n    const schema = await loadSchema(schemaPointer, {\n      headers: options.headers,\n    });\n    const documents = await loadDocuments(documentsPointer);\n\n    const invalidDocuments = validateDocuments(schema, documents, {\n      strictFragments: !options.noStrictFragments,\n      maxDepth: options.maxDepth || undefined,\n    });\n\n    if (!invalidDocuments.length) {\n      renderer.success('All documents are valid');\n    } else {\n      const errorsCount = countErrors(invalidDocuments);\n      const deprecated = countDeprecated(invalidDocuments);\n\n      if (errorsCount) {\n        renderer.emit(\n          `\\nDetected ${errorsCount} invalid document${\n            errorsCount > 1 ? 's' : ''\n          }:\\n`,\n        );\n\n        invalidDocuments.forEach(doc => {\n          if (doc.errors.length) {\n            renderer.emit(...renderInvalidDocument(doc));\n          }\n        });\n      } else if (!options.deprecated) {\n        renderer.success('All documents are valid');\n      }\n\n      if (deprecated) {\n        renderer.emit(\n          `\\nDetected ${deprecated} document${\n            deprecated > 1 ? 's' : ''\n          } with deprecated fields:\\n`,\n        );\n\n        invalidDocuments.forEach(doc => {\n          if (doc.deprecated.length) {\n            renderer.emit(\n              ...renderDeprecatedUsageInDocument(doc, options.deprecated),\n            );\n          }\n        });\n      }\n\n      if (errorsCount || (deprecated && options.deprecated)) {\n        process.exit(1);\n      }\n    }\n  } catch (e) {\n    renderer.error(e.message || e);\n    process.exit(1);\n  }\n\n  process.exit(0);\n}\n\nfunction countErrors(invalidDocuments: InvalidDocument[]): number {\n  if (invalidDocuments.length) {\n    return invalidDocuments.filter(doc => doc.errors && doc.errors.length)\n      .length;\n  }\n\n  return 0;\n}\n\nfunction countDeprecated(invalidDocuments: InvalidDocument[]): number {\n  if (invalidDocuments.length) {\n    return invalidDocuments.filter(\n      doc => doc.deprecated && doc.deprecated.length,\n    ).length;\n  }\n\n  return 0;\n}\n"]}